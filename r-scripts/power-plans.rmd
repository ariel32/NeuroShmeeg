---
title: "План наблюдений"
author: "mz"
date: "`r Sys.time()`"
output: html_document
---

```{r init,echo=FALSE,results='hide'}

library(knitr)
library(pwr)
library(SampleSizeMeans)
#library(samplesize)
#library(Sample.Size)
#library(TrialSize)

pwr       <- .8
alpha     <- .05
#eff.size  <- .1
eff.size  <- cohen.ES(test="t",size="small")$effect.size

stages  = c("00: Постановка в очередь",
                "01: Обращение к провизору",
                "02: Фармэкспертиза рецепта",
                "03: Док-т для Л",
                "04: Информация о применении",
                "05: Поиск в БД",
                "06: Поиск на МХ",
                "07: Таксировка",
                "08: Оформление отрывных корешков",
                "09: Карта ЛО",
                "10: Демонстрация МИ",
                "11: Инф. об эксп. МИ",
                "12: Гарантийный талон",
                "13: Упаковка-Маркировка-Срок годности",
                "14: Копия инструкции",
                "15: Копия рецепта",
                "16: Не проходящий товар",
                "17: Скидка",
                "18: Расчеты",
                "19: Обратная сторона",
                "20: Рецептурный журнал",
                "Окончание обслуживания")
bops    = c("а. Подготовительные работы",
                "б. Предоставление информации по телефону",
                "в. Приемка товаров, приемочный контроль",
                "г. Пополнение отделов аптеки ЛС, МИ, ТАА",
                "д. Оформление витрин аптеки",
                "е. Контроль сроков годности и реализации",
                "ж. Ведение учета и отчетности",
                "з. Рассмотрение замечаний и предложений",
                "и. Сбор информации о побочных реакциях на ЛС",
                "к. Санитарно-просветительная работа",
                "л. Контроль температуры и влажности",
                "м. Информирование мед. представителями",
                "н. Регламентированный перерыв",
                "о-1. Перерыв из-за отсутствия посетителей",
                "о-2. Другие нерегламентированные перерывы",
                "п. Заключительные работы")

factors <- list(
    modes                   = c("Rx1",
                                "Rx2",
                                "Rx3",
                                "Rx -",
                                "ИМТ/ТАА",
                                "RxL"),
    cs.cat                  = c("Первой",
                                "Второй",
                                "Третьей",
                                "Четвертой",
                                "Пятой"),
    provisor.exp.general    = seq(0,40),
    provisor.exp.cont       = seq(0,40),
    provisor.exp.age        = seq(0,65),
    provisor.sex            = c("Мужской",
                                "Женский"),
    provisor.education      = c("Высшее",
                                "Среднее"),
    provisor.qual.cats      = c("Без категории",
                                "Вторая",
                                "Первая",
                                "Высшая"))

```

# Планирование исследования 
по опеределению параметров системы обслуживания

Итак, ведя наблюдения а аптеке за процессом обслуживания клиентов провизром/фармацевтом на смене. В определенный момент возникает классический вопрос: «быть или не быть?» следующему наблюдению. 

Чтобы иметь обоснованный план по количеству и набору параметров наблюдения необходимо определить границы достижения целей исследования. Если быть точным то нужно выбрать эффект и его условную величину, которые будут отождествлены с поставленой целью.

В данном случае планируется задавать два основных вопроса: 

  * каковы статистически обоснованные пределы измеряемых величин, то есть среднее ± погрешность или медиана и интерквартильное расстояние (Осторожно! Возможен бутстрепинг);
  * достоверно ли отличие между величинами измерений проведенных в различных условиях.
  
Это означает что, во-первых, необходимо запланировать количество измерений для определения погрешности с заданной точностью. А, во-вторых, выбрать критерий различий и составить для него полный факторный план наблюдений. 

# Количество измерений для определения величин параметров

Измерению подлежат следующие этапы обслуживания:

```{r measured_steps,echo=FALSE,warning=FALSE,error=FALSE}
kable(matrix(c(stages, rep("",(length(stages) %% 3)+1)),ncol=3))
```

<br>

Всего величин, требующих измерения — `r length(stages)` , но их количество не имеет значения, однако, следует учесть что каждая величина должна быть измерена необходимое число раз, а получены они будут только в составе всей процедуры обслуживания.

Таким образом если принять, что интересующая величина эффекта — `r eff.size`, то подходящей будет считаться выборка такого размера, чтобы гипотеза о попадания в интервал $\bar{m} \pm `r eff.size`$ альтернативной средней была отвергнута при $\alpha = `r alpha`$ и мощности — `r pwr`. То есть это фактически t-тест по Стьюденту с двухсторонней гипотезой $H_0: \bar{m} = \bar{m}' \Rightarrow \bar{m} = \bar{m} \pm (`r eff.size` \times m)$. 

```{r m_measure_trial_num,echo=FALSE,results='hide'}

sample.n <- round(pwr.t.test(d = eff.size,
  power=pwr, sig.level=alpha, alternative="two.sided")$n)

```

Описанный подход определяет минимальный объем выборки — `r sample.n`, для каждого этапа обслуживания.

# Факторный план для выявления различий

## Полный факторный план

```{r,echo=FALSE}

f.counts <- sapply(factors, length)
f.counts['provisor.exp.age']      <- 5
f.counts['provisor.exp.general']  <- 5
f.counts['provisor.exp.cont']     <- 5

```

<<<<<<< HEAD
Полный факторный план предполагает что необходимое с точки зрения точности число наблюдений выполняетя для каждой комбинации факторов. Что это значит для данного исследования? Ничего хорошего ): Исследование предполагает фиксировать `r length(factors)` различных фактров для каждого наблюдения, число уровней каждого фактора варьирует от `r min(f.counts)` до `r max(f.counts)`, число же комбинаций равно `r sprintf('%.0e',prod(f.counts))`. Это невообразимо много, если сделать нужно за год в одиночку, как говорил классик: «Вселенная велика. Вы даже представить себе не можете насколько она велика». Так вот, наше число еще кое-как представимо, но вот число измерений выводит его за рамки всяких приличий потому что это число — `r sprintf('%.0e',prod(f.counts) * sample.n)`.

Пока это грубая (пессимистичная/трудоемизирующая) прикидка, потому что не учитывает, например, что не все операции выполняются при всех вариантах обслуживания. Так что stay tuned.
